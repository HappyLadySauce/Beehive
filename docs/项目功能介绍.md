# Beehive IM 即时通讯系统 - 项目功能介绍

## 核心功能

- **基于微服务架构设计**：系统采用微服务架构，包含6个独立的微服务（Auth Service、User Service、Message Service、Presence Service、Search Service、Gateway Service），每个服务职责明确，支持独立部署和水平扩展。使用 etcd 实现服务注册与发现，通过 gRPC 进行服务间通信，确保系统的高可用性和可扩展性。

- **实现了完整的JWT认证授权系统**：基于 JWT Token 实现用户登录认证，支持 Token 生成、验证、刷新和撤销功能。Token 信息缓存到 Redis，通过黑名单机制实现 Token 撤销，支持 Access Token 和 Refresh Token 双令牌机制，确保系统安全性。所有 WebSocket 连接必须携带有效 Token 进行认证。

- **实现了基于 WebSocket 的实时通信功能**：Gateway Service 管理所有 WebSocket 连接，支持连接注册、注销和心跳检测机制。实现了连接管理器（Connection Manager），自动处理连接断开和重连，支持单用户多设备连接管理。所有消息通过 WebSocket 实时推送，确保消息的即时性。

- **实现了完整的单聊和群聊消息功能**：支持单聊消息的点对点发送和群聊消息的广播发送。消息通过 Message Service 持久化到 PostgreSQL 数据库，同时通过 RabbitMQ 消息队列实现异步消息推送。支持消息状态管理（已发送、已送达、已读），实现了未读消息查询和标记已读功能。

- **使用 RabbitMQ 实现异步消息转发机制**：Message Service 作为消息生产者，Gateway Service 作为消息消费者，通过 Direct Exchange 路由单聊消息，通过 Topic Exchange 路由群聊消息。消息持久化到队列，支持消息重试和死信队列机制，确保消息的可靠传递。实现了消息批量推送，提高系统性能。

- **集成 Elasticsearch 实现历史消息全文检索功能**：使用 Elasticsearch 8.11 作为搜索引擎，集成 IK Analyzer 中文分词器，支持消息内容的全文搜索。实现了单聊消息搜索、群聊消息搜索和全局消息搜索功能，支持关键词高亮显示、时间范围筛选和多维度查询。Message Service 自动将新消息异步索引到 Elasticsearch，支持批量数据同步和索引重建。

- **实现了用户在线状态管理功能**：Presence Service 负责管理用户在线状态，使用 Redis 缓存用户在线信息，支持用户上线/下线通知。Gateway Service 在用户连接建立时自动通知 Presence Service，支持批量查询用户在线状态，实现了实时在线状态同步。

- **实现了离线消息自动推送功能**：当用户上线建立 WebSocket 连接时，系统自动查询并推送离线期间收到的未读消息。支持批量推送离线消息，减少网络请求次数，提升用户体验。消息推送失败时自动标记为未读，确保消息不丢失。

- **实现了会话管理功能**：支持会话列表查询，按最后消息时间排序，显示会话的未读消息数量。实现了会话详情查询，支持分页获取会话中的历史消息，优化了大数据量场景下的查询性能。

- **使用 Redis 缓存用户会话状态和 Token 信息**：Auth Service 将 Token 验证结果缓存到 Redis，减少对数据库的访问，提升认证性能。Presence Service 使用 Redis 存储用户在线状态，支持快速查询和更新。实现了缓存过期机制，确保数据一致性。

- **实现了基于 etcd 的服务注册与发现机制**：所有微服务启动时自动注册到 etcd，Gateway Service 通过 etcd 服务发现动态连接各个业务服务。支持服务健康检查，通过 etcd 租约机制实现自动故障检测和服务下线，实现了负载均衡和服务高可用。

- **实现了消息队列的可靠传递机制**：使用 RabbitMQ 的持久化 Exchange 和 Queue，确保消息不丢失。实现了消息确认机制（ACK），支持消息重试和失败处理。Gateway Service 消费消息时自动查找用户连接，在线用户实时推送，离线用户标记为未读，实现了消息的可靠投递。

- **实现了完整的用户管理功能**：User Service 提供用户注册、用户信息查询和更新功能。支持用户资料管理（昵称、头像、邮箱、描述），实现了密码加密存储（使用盐值+哈希），确保用户数据安全。Auth Service 通过 gRPC 调用 User Service 获取用户信息进行认证。

- **实现了消息搜索的高性能优化**：Search Service 使用 Elasticsearch 的 Bulk API 批量索引消息，使用异步索引机制不阻塞消息发送流程。实现了索引优化配置（分片、副本、刷新间隔），支持海量消息的快速检索，搜索响应时间控制在毫秒级。

- **实现了 WebSocket 连接的心跳检测机制**：Gateway Service 定期向客户端发送 Ping 消息，检测连接是否存活。实现了连接超时自动断开，防止僵尸连接占用资源。支持连接读写超时配置，确保连接的稳定性。

- **实现了消息推送的批量处理优化**：Gateway Service 支持向单个用户或批量用户推送消息，实现了消息推送的异步处理。群聊消息自动推送给所有在线群成员，离线成员消息标记为未读，优化了群聊场景下的性能。

- **使用 Docker Compose 实现基础设施的一键部署**：提供了完整的 Docker Compose 配置，包括 PostgreSQL、Redis、RabbitMQ、Elasticsearch、Kibana、etcd 等基础设施服务。支持开发环境和生产环境的快速部署，简化了系统部署流程。

- **实现了完整的错误处理和日志记录机制**：所有服务使用结构化日志（JSON 格式），支持日志级别配置。实现了统一的错误码体系，Gateway Service 通过 WebSocket 向客户端推送错误信息，实现了友好的错误提示机制。

- **实现了配置文件的统一管理**：使用 Viper 进行配置管理，支持 YAML 格式配置文件。每个服务有独立的配置文件，支持环境变量覆盖，实现了配置的热加载和动态更新。

- **实现了 gRPC 服务的优雅关闭机制**：所有微服务实现了优雅关闭，正确处理系统信号（SIGTERM、SIGINT），等待正在处理的请求完成后再关闭服务。实现了连接池管理，确保资源的正确释放。
